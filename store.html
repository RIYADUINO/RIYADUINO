<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIYADUINO | Professional Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Plus+Jakarta+Sans:wght@300;400;600&family=IBM+Plex+Sans+Arabic:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root {
            --bg-deep: #050505;
            --bg-panel: #0E0E0E;
            --gold-primary: #FFD700;
            --gold-glow: rgba(255, 215, 0, 0.4);
            --text-white: #ffffff;
            --text-grey: #b0b0b0;
            --border-tech: 1px solid rgba(255, 255, 255, 0.15);
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --font-arabic-body: 'IBM Plex Sans Arabic', sans-serif;
            --font-tech: 'Orbitron', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background-color: var(--bg-deep); color: var(--text-white); 
            font-family: var(--font-main); overflow-x: hidden;
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* RIYADUINO MESSAGES */
        #notification-area {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 3000; display: flex; flex-direction: column; gap: 10px;
            pointer-events: none; width: 90%; max-width: 450px;
        }
        .notify-toast {
            background: rgba(14, 14, 14, 0.98); border: 1px solid var(--gold-primary);
            color: #fff; padding: 15px 20px; border-radius: 8px; font-family: var(--font-tech);
            font-size: 0.85rem; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            animation: slideDown 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            pointer-events: auto; line-height: 1.4;
        }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Navigation */
        nav {
            position: sticky; top: 0; background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(10px);
            border-bottom: var(--border-tech); padding: 15px 5%;
            display: flex; justify-content: space-between; align-items: center; z-index: 1000;
        }
        .logo { font-family: var(--font-tech); font-weight: 800; font-size: 1.5rem; color: #fff; text-decoration: none; }
        .logo span { color: var(--gold-primary); text-shadow: 0 0 10px var(--gold-glow); }
        .nav-links { display: flex; align-items: center; gap: 15px; }

        /* Auth & Profile */
        .auth-btn-wrapper { display: flex; align-items: center; gap: 10px; }
        .google-auth-btn {
            display: flex; align-items: center; gap: 8px; background: #fff; color: #111; border: none;
            padding: 8px 14px; border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 0.8rem;
        }
        .user-avatar { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--gold-primary); cursor: pointer; display: none; }

        /* Icons */
        .icon-btn { cursor: pointer; position: relative; color: #fff; transition: 0.2s; }
        .icon-btn:hover { color: var(--gold-primary); }
        .badge { 
            position: absolute; top: -8px; right: -8px; background: var(--gold-primary); color: #000; 
            font-size: 0.65rem; font-weight: bold; padding: 2px 6px; border-radius: 10px;
        }

        /* Main UI */
        .container { max-width: 1300px; margin: 0 auto; padding: 40px 20px; flex-grow: 1; width: 100%; }
        .filter-tabs { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; }
        .filter-btn {
            background: transparent; border: 1px solid #333; color: #888; padding: 10px 25px;
            font-family: var(--font-tech); font-weight: 700; cursor: pointer; border-radius: 4px; transition: 0.3s;
        }
        .filter-btn.active { background: var(--gold-primary); color: #000; border-color: var(--gold-primary); }

        /* Products Grid */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .product-card {
            background: var(--bg-panel); border: var(--border-tech); border-radius: 12px; overflow: hidden;
            transition: 0.3s; cursor: pointer; position: relative;
        }
        .product-card:hover { border-color: var(--gold-primary); transform: translateY(-5px); }
        .img-box { height: 200px; background: #000; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; }
        .p-info { padding: 20px; }
        .p-title { font-weight: 600; font-size: 1.1rem; margin-bottom: 8px; }
        .p-price { color: var(--gold-primary); font-family: var(--font-tech); font-weight: 700; }

        /* Modals (Generic) */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-overlay.open { display: flex; }

        /* Product Detail Modal */
        .detail-modal { 
            background: #111; width: 90%; max-width: 850px; display: grid; grid-template-columns: 1.2fr 1fr; 
            border: var(--border-tech); border-radius: 15px; overflow: hidden;
        }
        .detail-content { padding: 40px; }
        .quality-options { display: flex; gap: 10px; margin: 20px 0; }
        .q-opt { 
            flex: 1; padding: 10px; border: 1px solid #333; text-align: center; cursor: pointer; 
            border-radius: 6px; font-size: 0.8rem; color: #888; transition: 0.2s;
        }
        .q-opt.selected { border-color: var(--gold-primary); color: var(--gold-primary); background: rgba(255,215,0,0.1); }

        /* Sidebar Cart & History */
        .sidebar-panel { 
            background: #0a0a0a; width: 100%; max-width: 450px; height: 100%; margin-left: auto; 
            border-left: 1px solid #222; display: flex; flex-direction: column;
        }
        .panel-header { padding: 25px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; }
        .panel-content { flex-grow: 1; overflow-y: auto; padding: 20px; }

        /* Cart Items */
        .cart-item { display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #1a1a1a; padding-bottom: 15px; }
        .cart-item img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        .qty-ctrl { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .qty-btn { background: #222; border: none; color: #fff; width: 25px; height: 25px; cursor: pointer; border-radius: 4px; }

        /* History Items */
        .history-card { background: #151515; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #222; }
        .history-date { font-size: 0.7rem; color: var(--gold-primary); font-family: var(--font-tech); margin-bottom: 5px; }
        .history-details { font-size: 0.85rem; color: #aaa; white-space: pre-wrap; }

        /* Forms */
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 6px; }

        .btn-gold { 
            width: 100%; padding: 15px; background: var(--gold-primary); color: #000; border: none; 
            font-weight: 800; cursor: pointer; font-family: var(--font-tech); border-radius: 6px; 
        }

        /* RTL Handling */
        body.ar { direction: rtl; font-family: var(--font-arabic-body); }
        body.ar .sidebar-panel { margin-left: 0; margin-right: auto; border-left: none; border-right: 1px solid #222; }

        @media (max-width: 768px) {
            .detail-modal { grid-template-columns: 1fr; }
            .detail-img { height: 250px; }
        }
    </style>
</head>
<body class="en">

    <div id="notification-area"></div>

    <nav>
        <a href="#" class="logo">RIYAD<span>UINO</span></a>
        <div class="nav-links">
            <button class="filter-btn" style="padding: 5px 10px;" onclick="toggleLang()">EN/AR</button>
            
            <div class="icon-btn" onclick="togglePanel('historyModal')">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>

            <div class="icon-btn" onclick="togglePanel('cartModal')">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                <div class="badge" id="cartCount">0</div>
            </div>

            <div class="auth-btn-wrapper">
                <button id="googleAuthBtn" class="google-auth-btn" onclick="handleAuth()">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/button/google.svg" width="18">
                    <span id="authText" data-en="Sign In" data-ar="دخول">Sign In</span>
                </button>
                <img id="userAvatar" class="user-avatar" onclick="handleAuth()">
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="filter-tabs">
            <button class="filter-btn active" onclick="setCategory('pieces')" data-en="PIECES" data-ar="القطع">PIECES</button>
            <button class="filter-btn" onclick="setCategory('projects')" data-en="PROJECTS" data-ar="المشاريع">PROJECTS</button>
        </div>
        <div id="loader" style="text-align:center; color:var(--gold-primary)">LOADING STORE...</div>
        <div class="products-grid" id="productsGrid"></div>
    </div>

    <div class="modal-overlay" id="productModal" onclick="closeModals()">
        <div class="detail-modal" onclick="event.stopPropagation()">
            <img id="modalImg" class="img-box" style="height:100%; object-fit:cover;">
            <div class="detail-content">
                <h2 id="modalTitle" style="font-family:var(--font-tech); margin-bottom:10px;"></h2>
                <div id="modalPrice" style="color:var(--gold-primary); font-size:1.5rem; font-weight:700; margin-bottom:15px;"></div>
                <p id="modalDesc" style="color:#888; font-size:0.9rem; line-height:1.6; margin-bottom:20px;"></p>
                
                <div class="quality-selector">
                    <label style="font-size:0.7rem; color:#555;" data-en="SELECT QUALITY" data-ar="اختر الجودة">SELECT QUALITY</label>
                    <div class="quality-options">
                        <div class="q-opt selected" onclick="selectQuality('Mid')" id="qMid" data-en="Mid Quality" data-ar="جودة متوسطة">Mid Quality</div>
                        <div class="q-opt" onclick="selectQuality('High')" id="qHigh" data-en="High Quality (+20%)" data-ar="جودة عالية (+20%)">High Quality</div>
                    </div>
                </div>
                <button id="modalAddBtn" class="btn-gold" data-en="ADD TO CART" data-ar="إضافة للسلة">ADD TO CART</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cartModal" onclick="closeModals()">
        <div class="sidebar-panel" onclick="event.stopPropagation()">
            <div class="panel-header">
                <h2 data-en="YOUR CART" data-ar="سلتك">YOUR CART</h2>
                <span style="cursor:pointer" onclick="closeModals()">✕</span>
            </div>
            <div id="cartItemsList" class="panel-content"></div>
            <div style="padding:25px; border-top:1px solid #222;">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-weight:700;">
                    <span data-en="Total" data-ar="المجموع">Total</span>
                    <span id="cartTotalDisplay">$0.00</span>
                </div>
                
                <div id="phoneInputSection" style="display:none; margin-bottom:15px;">
                    <div class="input-group">
                        <label data-en="Phone Number" data-ar="رقم الهاتف">Phone Number</label>
                        <input type="tel" id="userPhone" placeholder="05xxxxxxxx">
                    </div>
                </div>

                <form action="https://formspree.io/f/xzzkyzzp" method="POST" id="orderForm" onsubmit="validateAndSubmit(event)">
                    <input type="hidden" name="Order Details" id="hiddenOrderData">
                    <input type="hidden" name="User Email" id="hiddenUserEmail">
                    <input type="hidden" name="Phone" id="hiddenUserPhone">
                    <button type="submit" id="checkoutBtn" class="btn-gold" data-en="CHECKOUT NOW" data-ar="إتمام الشراء">CHECKOUT NOW</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="historyModal" onclick="closeModals()">
        <div class="sidebar-panel" onclick="event.stopPropagation()">
            <div class="panel-header">
                <h2 data-en="ORDER HISTORY" data-ar="سجل الطلبات">ORDER HISTORY</h2>
                <span style="cursor:pointer" onclick="closeModals()">✕</span>
            </div>
            <div id="historyContent" class="panel-content">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCSLy3xjL78iCWG9jLPTAIvi3-TJBPfsjw",
            authDomain: "riyaduino-sign-in-database.firebaseapp.com",
            projectId: "riyaduino-sign-in-database",
            storageBucket: "riyaduino-sign-in-database.firebasestorage.app",
            messagingSenderId: "783217624924",
            appId: "1:783217624924:web:183c079062776d3d06a399"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let currentLang = 'en';
        let allProducts = [];
        let cart = [];
        let selectedQuality = 'Mid';

        // --- CUSTOM MESSAGES ---
        window.notify = (msg) => {
            const area = document.getElementById('notification-area');
            const t = document.createElement('div');
            t.className = 'notify-toast';
            t.innerHTML = `<strong>RIYADUINO SAYS:</strong><br>${msg}`;
            area.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 400); }, 5000);
        };

        // --- AUTH & DATA ---
        window.handleAuth = async () => {
            if (currentUser) await signOut(auth);
            else await signInWithPopup(auth, provider);
        };

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const avatar = document.getElementById('userAvatar');
            const authBtn = document.getElementById('googleAuthBtn');
            if (user) {
                avatar.src = user.photoURL; avatar.style.display = 'block';
                authBtn.style.display = 'none';
                await syncUserData();
            } else {
                avatar.style.display = 'none'; authBtn.style.display = 'flex';
                cart = []; updateCartUI();
            }
        });

        async function syncUserData() {
            const ref = doc(db, "users", currentUser.uid);
            const snap = await getDoc(ref);
            if (snap.exists()) {
                cart = snap.data().cart || [];
                renderHistory(snap.data().history || []);
            } else {
                await setDoc(ref, { cart: [], history: [] });
            }
            updateCartUI();
        }

        async function saveCart() {
            if (currentUser) await updateDoc(doc(db, "users", currentUser.uid), { cart: cart });
        }

        // --- STORE LOGIC ---
        const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTBQd3LUgZKxeuRQA2B0Cj3IvJBSSS0VL2vnmtOryQxFsAK-Kikg_NZTVGtlYghB96yFYyvqXrPGJEu/pub?output=csv";

        async function loadStore() {
            Papa.parse(sheetURL, {
                download: true, header: true,
                complete: (res) => {
                    allProducts = res.data;
                    document.getElementById('loader').style.display = 'none';
                    renderProducts();
                }
            });
        }

        window.setCategory = (cat) => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderProducts(cat);
        };

        function renderProducts(cat = 'pieces') {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = "";
            allProducts.filter(p => (p.category || 'pieces').toLowerCase() === cat).forEach((p, i) => {
                const inStock = p.instock?.toLowerCase() === 'true';
                grid.innerHTML += `
                    <div class="product-card" onclick="openProduct(${allProducts.indexOf(p)})">
                        <div class="img-box"><img src="${p.image}"></div>
                        <div class="p-info">
                            <div class="p-title">${p.name}</div>
                            <div class="p-price">${p.price}</div>
                            <div style="font-size:0.7rem; color:${inStock?'#00ff41':'#ff003c'}">${inStock?'IN STOCK':'SOLD OUT'}</div>
                        </div>
                    </div>`;
            });
        }

        window.openProduct = (idx) => {
            const p = allProducts[idx];
            if(p.instock?.toLowerCase() !== 'true') return notify(currentLang==='en'?"Out of stock!":"نفذت الكمية!");
            document.getElementById('modalImg').src = p.image;
            document.getElementById('modalTitle').innerText = p.name;
            document.getElementById('modalPrice').innerText = p.price;
            document.getElementById('modalDesc').innerText = p.description || "...";
            selectQuality('Mid');
            document.getElementById('productModal').classList.add('open');
            document.getElementById('modalAddBtn').onclick = () => addToCart(idx);
        };

        window.selectQuality = (q) => {
            selectedQuality = q;
            document.querySelectorAll('.q-opt').forEach(o => o.classList.remove('selected'));
            document.getElementById('q'+q).classList.add('selected');
        };

        window.addToCart = (idx) => {
            const p = allProducts[idx];
            let price = parseFloat(p.price.replace(/[^0-9.]/g, ''));
            if(selectedQuality === 'High') price *= 1.2;
            
            const existing = cart.find(item => item.idx === idx && item.quality === selectedQuality);
            if(existing) existing.qty++;
            else cart.push({ idx, name: p.name, price: price, qty: 1, quality: selectedQuality, img: p.image });
            
            updateCartUI(); saveCart(); closeModals();
            notify(currentLang==='en'?"Added to cart!":"تمت الإضافة للسلة!");
        };

        window.updateCartUI = () => {
            const list = document.getElementById('cartItemsList');
            let total = 0;
            list.innerHTML = cart.length ? "" : "<p style='color:#444; text-align:center;'>Empty</p>";
            cart.forEach((item, i) => {
                total += item.price * item.qty;
                list.innerHTML += `
                    <div class="cart-item">
                        <img src="${item.img}">
                        <div style="flex:1">
                            <div style="font-size:0.9rem;">${item.name}</div>
                            <div style="font-size:0.7rem; color:#666;">${item.quality} Quality</div>
                            <div class="qty-ctrl">
                                <button class="qty-btn" onclick="changeQty(${i},-1)">-</button>
                                <span>${item.qty}</span>
                                <button class="qty-btn" onclick="changeQty(${i},1)">+</button>
                            </div>
                        </div>
                        <div style="color:var(--gold-primary); font-weight:700;">$${(item.price * item.qty).toFixed(2)}</div>
                    </div>`;
            });
            document.getElementById('cartTotalDisplay').innerText = "$" + total.toFixed(2);
            document.getElementById('cartCount').innerText = cart.reduce((a, b) => a + b.qty, 0);
        };

        window.changeQty = (i, d) => {
            cart[i].qty += d;
            if(cart[i].qty <= 0) cart.splice(i, 1);
            updateCartUI(); saveCart();
        };

        // --- CHECKOUT & HISTORY ---
        window.validateAndSubmit = async (e) => {
            e.preventDefault();
            if(!currentUser) return notify(currentLang==='en'?"Please Sign In":"يرجى تسجيل الدخول");
            if(!cart.length) return;

            const section = document.getElementById('phoneInputSection');
            const phone = document.getElementById('userPhone').value;

            if(section.style.display === 'none') {
                section.style.display = 'block';
                return notify(currentLang==='en'?"Please enter your phone number to confirm":"يرجى إدخال رقم الهاتف للتأكيد");
            }

            if(phone.length < 8) return notify(currentLang==='en'?"Invalid Phone":"رقم غير صحيح");

            const orderStr = cart.map(i => `${i.name} (${i.quality}) x${i.qty}`).join('\n');
            document.getElementById('hiddenOrderData').value = orderStr;
            document.getElementById('hiddenUserEmail').value = currentUser.email;
            document.getElementById('hiddenUserPhone').value = phone;

            const btn = document.getElementById('checkoutBtn');
            btn.disabled = true; btn.innerText = "...";

            try {
                await fetch(e.target.action, { method: 'POST', body: new FormData(e.target), headers: {'Accept': 'application/json'} });
                
                // Add to Firestore History
                await updateDoc(doc(db, "users", currentUser.uid), {
                    history: arrayUnion({ date: new Date().toLocaleString(), details: orderStr }),
                    cart: []
                });

                notify(currentLang==='en' 
                    ? "Your order was submitted! We will check your order, check your interest in your order and start working on it!"
                    : "تم إرسال طلبك بنجاح! سنراجع الطلب ونتحقق من اهتمامك ونبدأ العمل عليه!");
                
                cart = []; updateCartUI(); closeModals();
                section.style.display = 'none';
                btn.disabled = false; btn.innerText = "CHECKOUT NOW";
                syncUserData(); // Refresh history
            } catch (err) { notify("Error!"); btn.disabled = false; }
        };

        function renderHistory(history) {
            const cont = document.getElementById('historyContent');
            cont.innerHTML = history.length ? "" : "<p style='color:#444;'>No previous orders.</p>";
            history.reverse().forEach(h => {
                cont.innerHTML += `
                    <div class="history-card">
                        <div class="history-date">${h.date}</div>
                        <div class="history-details">${h.details}</div>
                    </div>`;
            });
        }

        // --- UI HELPERS ---
        window.togglePanel = (id) => {
            closeModals();
            document.getElementById(id).classList.add('open');
        };
        window.closeModals = () => {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open'));
        };
        window.toggleLang = () => {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            document.body.className = currentLang;
            document.querySelectorAll('[data-en]').forEach(el => el.innerText = el.getAttribute('data-'+currentLang));
            renderProducts();
        };

        loadStore();
    </script>
</body>
</html>
