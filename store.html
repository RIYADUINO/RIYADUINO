<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIYADUINO | Professional Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Cairo:wght@300;400;700;900&family=Plus+Jakarta+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root {
            --bg-deep: #050505;
            --bg-panel: #0E0E0E;
            --gold-primary: #FFD700;
            --gold-glow: rgba(255, 215, 0, 0.4);
            --text-white: #ffffff;
            --border-tech: 1px solid rgba(255, 255, 255, 0.1);
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --font-arabic: 'Cairo', sans-serif;
            --font-tech: 'Orbitron', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background-color: var(--bg-deep); color: var(--text-white); 
            font-family: var(--font-main); overflow-x: hidden;
            display: flex; flex-direction: column; min-height: 100vh;
        }
        body.ar { font-family: var(--font-arabic); direction: rtl; }

        /* --- COUPON STRAP --- */
        .coupon-ticker {
            background: linear-gradient(90deg, #b8860b, #FFD700, #b8860b);
            color: #000; overflow: hidden; white-space: nowrap;
            padding: 10px 0; font-family: var(--font-tech); font-weight: 900;
            font-size: 0.85rem; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            border-bottom: 2px solid rgba(0,0,0,0.1);
        }
        .ticker-content { display: inline-block; animation: ticker 30s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        
        /* Force the code to stay as 3mk regardless of language */
        .promo-code { display: inline-block; direction: ltr; background: rgba(0,0,0,0.8); color: #fff; padding: 2px 8px; border-radius: 4px; margin: 0 5px; }

        /* --- PARTICLES CANVAS --- */
        #particleCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

        /* RIYADUINO TOASTS */
        #notification-area {
            position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
            z-index: 5000; display: flex; flex-direction: column; gap: 10px;
            pointer-events: none; width: 90%; max-width: 450px;
        }
        .notify-toast {
            background: rgba(10, 10, 10, 0.98); border: 2px solid var(--gold-primary);
            color: #fff; padding: 18px 25px; border-radius: 4px; font-family: var(--font-tech);
            font-size: 0.85rem; box-shadow: 0 0 40px rgba(255, 215, 0, 0.2);
            animation: slideDown 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            pointer-events: auto; line-height: 1.6;
        }
        body.ar .notify-toast { font-family: var(--font-arabic); font-weight: 700; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Navigation */
        nav {
            position: sticky; top: 0; background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(15px);
            border-bottom: var(--border-tech); padding: 15px 5%;
            display: flex; justify-content: space-between; align-items: center; z-index: 1000;
        }
        .logo { font-family: var(--font-tech); font-weight: 900; font-size: 1.6rem; color: #fff; text-decoration: none; letter-spacing: -1px; }
        .logo span { color: var(--gold-primary); text-shadow: 0 0 15px var(--gold-glow); }
        
        .nav-links { display: flex; align-items: center; gap: 20px; }
        .icon-btn { cursor: pointer; position: relative; transition: 0.3s; color: #888; }
        .icon-btn:hover { color: var(--gold-primary); transform: translateY(-2px); }
        .badge { 
            position: absolute; top: -10px; right: -10px; background: var(--gold-primary); color: #000; 
            font-size: 0.65rem; font-weight: 900; padding: 2px 6px; border-radius: 10px;
        }

        /* Products Grid */
        .container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; flex-grow: 1; width: 100%; }
        .filter-tabs { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; }
        .filter-btn {
            background: rgba(255,255,255,0.03); border: 1px solid #222; color: #666; padding: 12px 35px;
            font-family: var(--font-tech); font-weight: 700; cursor: pointer; border-radius: 4px; transition: 0.3s;
        }
        .filter-btn.active { background: var(--gold-primary); color: #000; border-color: var(--gold-primary); box-shadow: 0 0 20px var(--gold-glow); }

        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }
        .product-card {
            background: var(--bg-panel); border: var(--border-tech); border-radius: 8px; overflow: hidden;
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer;
        }
        .product-card:hover { border-color: var(--gold-primary); transform: translateY(-10px); }
        .img-box { height: 220px; overflow: hidden; background: #000; position: relative; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: 0.6s; }
        .product-card:hover img { opacity: 1; transform: scale(1.1); }
        .p-info { padding: 25px; border-top: var(--border-tech); }
        .p-title { font-weight: 700; font-size: 1.15rem; margin-bottom: 5px; }
        .p-price { color: var(--gold-primary); font-family: var(--font-tech); font-weight: 700; }

        /* Sidebar Panels */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.94); backdrop-filter: blur(12px);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-overlay.open { display: flex; }

        .sidebar-panel { 
            background: #080808; width: 100%; max-width: 500px; height: 100%; margin-left: auto; 
            border-left: 1px solid #1a1a1a; display: flex; flex-direction: column; animation: slideIn 0.4s ease-out forwards;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        body.ar .sidebar-panel { margin-left: 0; margin-right: auto; border-left: none; border-right: 1px solid #1a1a1a; animation: slideInAr 0.4s ease-out forwards; }
        @keyframes slideInAr { from { transform: translateX(-100%); } to { transform: translateX(0); } }

        .panel-header { padding: 35px; border-bottom: 1px solid #1a1a1a; display: flex; justify-content: space-between; align-items: center; }
        .panel-content { flex-grow: 1; overflow-y: auto; padding: 30px; }

        /* Coupon / Inputs */
        .coupon-box { 
            background: #111; border: 1px dashed #444; padding: 15px; border-radius: 4px; margin-bottom: 25px;
            display: flex; gap: 10px;
        }
        .coupon-box input { 
            flex: 1; background: #000; border: 1px solid #222; color: var(--gold-primary); 
            padding: 10px; border-radius: 4px; font-family: var(--font-tech); outline: none; text-align: center;
        }
        .coupon-box button { 
            background: #222; color: #fff; border: none; padding: 0 20px; 
            cursor: pointer; font-size: 0.75rem; font-weight: 900; font-family: var(--font-tech);
        }

        .btn-gold { 
            width: 100%; padding: 20px; background: var(--gold-primary); color: #000; border: none; 
            font-weight: 900; cursor: pointer; font-family: var(--font-tech); border-radius: 4px;
            transition: 0.3s; text-transform: uppercase;
        }
        .btn-gold:hover:not(:disabled) { background: #fff; box-shadow: 0 0 30px rgba(255,255,255,0.2); }
        body.ar .btn-gold { font-family: var(--font-arabic); }

        #userPhone { width: 100%; padding: 15px; background: #000; border: 1px solid #333; color: #fff; margin-bottom: 20px; border-radius: 4px; text-align: center; }

    </style>
</head>
<body class="en">

    <div class="coupon-ticker">
        <div class="ticker-content">
            USE CODE: <span class="promo-code">3mk</span> FOR 15% OFF YOUR ENTIRE ORDER • 
            استخدم الكود الحصري: <span class="promo-code">3mk</span> للحصول على خصم 15% على جميع طلباتك • 
            USE CODE: <span class="promo-code">3mk</span> FOR 15% OFF YOUR ENTIRE ORDER • 
            استخدم الكود الحصري: <span class="promo-code">3mk</span> للحصول على خصم 15% على جميع طلباتك • 
        </div>
    </div>

    <canvas id="particleCanvas"></canvas>
    <div id="notification-area"></div>

    <nav>
        <a href="#" class="logo">RIYAD<span>UINO</span></a>
        <div class="nav-links">
            <button class="filter-btn" style="padding: 5px 15px; font-size: 0.75rem;" onclick="toggleLang()">EN / AR</button>
            
            <div class="icon-btn" onclick="togglePanel('historyModal')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>

            <div class="icon-btn" onclick="togglePanel('cartModal')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4H6z"/><path d="M3 6h18M16 10a4 4 0 01-8 0"/></svg>
                <div class="badge" id="cartCount">0</div>
            </div>

            <div class="auth-btn-wrapper">
                <button id="googleAuthBtn" class="google-auth-btn" onclick="handleAuth()" style="display:flex; align-items:center; gap:8px; background:#fff; border:none; padding:8px 15px; cursor:pointer; font-weight:900; font-size:0.7rem; border-radius:4px;">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/button/google.svg" width="16">
                    <span id="authText">SIGN IN</span>
                </button>
                <img id="userAvatar" class="user-avatar" style="width:35px; height:35px; border-radius:50%; border:2px solid var(--gold-primary); display:none; cursor:pointer;" onclick="handleAuth()">
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="filter-tabs">
            <button class="filter-btn active" onclick="setCategory('pieces')" data-en="COMPONENTS" data-ar="قطع الغيار">COMPONENTS</button>
            <button class="filter-btn" onclick="setCategory('projects')" data-en="PROJECTS" data-ar="المشاريع">PROJECTS</button>
        </div>
        <div id="loader" style="text-align:center; color:var(--gold-primary); font-family:var(--font-tech); font-size:0.8rem;">[ SYSTEM INITIALIZING... ]</div>
        <div class="products-grid" id="productsGrid"></div>
    </div>

    <div class="modal-overlay" id="productModal" onclick="closeModals()">
        <div class="sidebar-panel" style="max-width: 600px; margin: auto; height: auto; border-radius: 8px;" onclick="event.stopPropagation()">
            <img id="modalImg" style="width:100%; height:350px; object-fit:cover;">
            <div class="panel-content">
                <h2 id="modalTitle" style="font-family:var(--font-tech); margin-bottom:10px;"></h2>
                <div id="modalPrice" style="color:var(--gold-primary); font-size:1.8rem; font-weight:900; margin-bottom:15px; font-family:var(--font-tech);"></div>
                <p id="modalDesc" style="color:#aaa; line-height:1.8; margin-bottom:30px; font-size:0.95rem;"></p>
                
                <div class="quality-selector">
                    <label style="font-size:0.7rem; color:var(--gold-primary); font-weight:900; letter-spacing:1px;" data-en="UPGRADE QUALITY" data-ar="ترقية الجودة">UPGRADE QUALITY</label>
                    <div class="quality-options">
                        <div class="q-opt selected" onclick="selectQuality('Mid')" id="qMid" data-en="Standard" data-ar="عادية">Standard</div>
                        <div class="q-opt" onclick="selectQuality('High')" id="qHigh" data-en="High-End (+20%)" data-ar="عالية (+20%)">High-End</div>
                    </div>
                </div>
                <button id="modalAddBtn" class="btn-gold" style="margin-top:25px;" data-en="ADD TO SYSTEM" data-ar="إضافة للطلب">ADD TO SYSTEM</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cartModal" onclick="closeModals()">
        <div class="sidebar-panel" onclick="event.stopPropagation()">
            <div class="panel-header">
                <h2 data-en="CART OVERVIEW" data-ar="مراجعة السلة">CART OVERVIEW</h2>
                <span style="cursor:pointer; font-size:1.2rem;" onclick="closeModals()">✕</span>
            </div>
            <div id="cartItemsList" class="panel-content"></div>
            <div style="padding:35px; border-top:1px solid #1a1a1a; background:#050505;">
                
                <div class="coupon-box">
                    <input type="text" id="couponInput" placeholder="Enter Code" data-en-p="Coupon Code" data-ar-p="كود الخصم">
                    <button onclick="applyCoupon()" data-en="APPLY" data-ar="تفعيل">APPLY</button>
                </div>

                <div style="display:flex; justify-content:space-between; margin-bottom:25px; font-weight:900; font-size:1.4rem;">
                    <span data-en="Total Amount" data-ar="المجموع">Total Amount</span>
                    <span id="cartTotalDisplay" style="color:var(--gold-primary)">$0.00</span>
                </div>

                <div id="phoneInputSection" style="display:none;">
                    <input type="text" id="userPhone" placeholder="05xxxxxxxx" maxlength="14">
                </div>

                <form action="https://formspree.io/f/xzzkyzzp" method="POST" id="orderForm" onsubmit="validateAndSubmit(event)">
                    <input type="hidden" name="Order_Summary" id="hiddenOrderData">
                    <input type="hidden" name="User_Email" id="hiddenUserEmail">
                    <input type="hidden" name="User_Phone" id="hiddenUserPhone">
                    <input type="hidden" name="Promo_Code" id="hiddenDiscount">
                    <button type="submit" id="checkoutBtn" class="btn-gold" data-en="FINALIZE ORDER" data-ar="تأكيد الطلب النهائي">FINALIZE ORDER</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="historyModal" onclick="closeModals()">
        <div class="sidebar-panel" onclick="event.stopPropagation()">
            <div class="panel-header">
                <h2 data-en="MISSION HISTORY" data-ar="سجل العمليات">MISSION HISTORY</h2>
                <span style="cursor:pointer" onclick="closeModals()">✕</span>
            </div>
            <div id="historyContent" class="panel-content"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCSLy3xjL78iCWG9jLPTAIvi3-TJBPfsjw",
            authDomain: "riyaduino-sign-in-database.firebaseapp.com",
            projectId: "riyaduino-sign-in-database",
            storageBucket: "riyaduino-sign-in-database.firebasestorage.app",
            messagingSenderId: "783217624924",
            appId: "1:783217624924:web:183c079062776d3d06a399"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let currentLang = 'en';
        let allProducts = [];
        let cart = [];
        let selectedQuality = 'Mid';
        let discountRate = 1.0;

        // --- PARTICLE LOGIC ---
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = canvas.height + 10;
                this.size = Math.random() * 4 + 1;
                this.speed = Math.random() * 4 + 2;
                this.opacity = 1;
            }
            update() { this.y -= this.speed; this.opacity -= 0.006; }
            draw() {
                ctx.fillStyle = `rgba(255, 215, 0, ${this.opacity})`;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
            }
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, i) => {
                p.update(); p.draw();
                if(p.opacity <= 0) particles.splice(i, 1);
            });
            if(particles.length > 0) requestAnimationFrame(animate);
        }

        function triggerEffect() {
            for(let i=0; i<120; i++) particles.push(new Particle());
            animate();
        }

        // --- NOTIFICATIONS ---
        window.notify = (msg) => {
            const area = document.getElementById('notification-area');
            const t = document.createElement('div');
            t.className = 'notify-toast';
            t.innerHTML = `<strong>RIYADUINO SAYS:</strong><br>${msg}`;
            area.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 400); }, 6000);
        };

        // --- AUTH ---
        window.handleAuth = async () => {
            if (currentUser) await signOut(auth);
            else await signInWithPopup(auth, provider);
        };

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const avatar = document.getElementById('userAvatar');
            const authBtn = document.getElementById('googleAuthBtn');
            if (user) {
                avatar.src = user.photoURL; avatar.style.display = 'block';
                authBtn.style.display = 'none';
                await syncData();
            } else {
                avatar.style.display = 'none'; authBtn.style.display = 'flex';
                cart = []; updateCartUI();
            }
        });

        async function syncData() {
            const ref = doc(db, "users", currentUser.uid);
            const snap = await getDoc(ref);
            if (snap.exists()) {
                cart = snap.data().cart || [];
                renderHistory(snap.data().history || []);
            } else await setDoc(ref, { cart: [], history: [] });
            updateCartUI();
        }

        // --- STORE ---
        const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTBQd3LUgZKxeuRQA2B0Cj3IvJBSSS0VL2vnmtOryQxFsAK-Kikg_NZTVGtlYghB96yFYyvqXrPGJEu/pub?output=csv";
        Papa.parse(sheetURL, {
            download: true, header: true,
            complete: (res) => {
                allProducts = res.data;
                document.getElementById('loader').style.display = 'none';
                renderProducts();
            }
        });

        window.setCategory = (cat) => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderProducts(cat);
        };

        function renderProducts(cat = 'pieces') {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = "";
            allProducts.filter(p => (p.category || 'pieces').toLowerCase() === cat).forEach((p, i) => {
                grid.innerHTML += `
                    <div class="product-card" onclick="openProduct(${allProducts.indexOf(p)})">
                        <div class="img-box"><img src="${p.image}"></div>
                        <div class="p-info">
                            <div class="p-title">${p.name}</div>
                            <div class="p-price">${p.price}</div>
                        </div>
                    </div>`;
            });
        }

        window.openProduct = (idx) => {
            const p = allProducts[idx];
            if(p.instock?.toLowerCase() !== 'true') return notify(currentLang==='en'?"Out of Stock":"الكمية نافذة");
            document.getElementById('modalImg').src = p.image;
            document.getElementById('modalTitle').innerText = p.name;
            document.getElementById('modalPrice').innerText = p.price;
            document.getElementById('modalDesc').innerText = p.description || "";
            selectQuality('Mid');
            document.getElementById('productModal').classList.add('open');
            document.getElementById('modalAddBtn').onclick = () => addToCart(idx);
        };

        window.selectQuality = (q) => {
            selectedQuality = q;
            document.querySelectorAll('.q-opt').forEach(o => o.classList.remove('selected'));
            document.getElementById('q'+q).classList.add('selected');
        };

        window.addToCart = (idx) => {
            const p = allProducts[idx];
            let price = parseFloat(p.price.replace(/[^0-9.]/g, ''));
            if(selectedQuality === 'High') price *= 1.2;
            cart.push({ idx, name: p.name, price, qty: 1, quality: selectedQuality, img: p.image });
            updateCartUI(); updateDoc(doc(db,"users",currentUser.uid),{cart:cart});
            closeModals();
            notify(currentLang==='en'?"Unit added to Command Center.":"تمت إضافة القطعة للمركز.");
        };

        window.updateCartUI = () => {
            const list = document.getElementById('cartItemsList');
            let subtotal = 0;
            list.innerHTML = cart.length ? "" : "<p style='text-align:center; color:#222; margin-top:50px;'>NO ACTIVE ITEMS</p>";
            cart.forEach((item, i) => {
                subtotal += item.price * item.qty;
                list.innerHTML += `
                    <div style="display:flex; gap:15px; margin-bottom:20px; border-bottom:1px solid #111; padding-bottom:15px;">
                        <img src="${item.img}" style="width:65px; height:65px; object-fit:cover; border-radius:4px;">
                        <div style="flex:1">
                            <div style="font-weight:700; font-size:0.95rem;">${item.name}</div>
                            <div style="font-size:0.7rem; color:#555;">${item.quality} Quality</div>
                            <div style="margin-top:8px;">
                                <button onclick="changeQty(${i},-1)" style="padding:4px 10px; background:#111; color:#fff; border:none; cursor:pointer;">-</button>
                                <span style="margin:0 12px; font-weight:bold;">${item.qty}</span>
                                <button onclick="changeQty(${i},1)" style="padding:4px 10px; background:#111; color:#fff; border:none; cursor:pointer;">+</button>
                            </div>
                        </div>
                        <div style="color:var(--gold-primary); font-family:var(--font-tech); font-weight:900;">$${(item.price * item.qty).toFixed(2)}</div>
                    </div>`;
            });

            const finalTotal = subtotal * discountRate;
            document.getElementById('cartTotalDisplay').innerText = "$" + finalTotal.toFixed(2);
            document.getElementById('cartCount').innerText = cart.length;
            
            if(discountRate < 1) {
                document.getElementById('cartTotalDisplay').style.color = "#00ff41";
                document.getElementById('cartTotalDisplay').innerHTML += ` <span style="font-size:0.75rem; color:#444; text-decoration:line-through; margin-left:10px;">$${subtotal.toFixed(2)}</span>`;
            }
        };

        window.changeQty = (i, d) => {
            cart[i].qty += d;
            if(cart[i].qty <= 0) cart.splice(i, 1);
            updateCartUI(); updateDoc(doc(db,"users",currentUser.uid),{cart:cart});
        };

        // --- COUPON ---
        window.applyCoupon = () => {
            const code = document.getElementById('couponInput').value.trim().toLowerCase();
            if(code === '3mk') {
                discountRate = 0.85;
                triggerEffect();
                notify(currentLang === 'en' ? "COUPON VERIFIED! 15% OFF." : "تم تفعيل كود الخصم! 15%");
                updateCartUI();
            } else notify(currentLang === 'en' ? "INVALID CODE" : "الكود غير صحيح");
        };

        // --- CHECKOUT ---
        window.validateAndSubmit = async (e) => {
            e.preventDefault();
            if(!currentUser) return handleAuth();
            if(!cart.length) return;

            const section = document.getElementById('phoneInputSection');
            const phoneInput = document.getElementById('userPhone');
            if(section.style.display === 'none') {
                section.style.display = 'block';
                phoneInput.focus();
                return notify(currentLang==='en'?"Provide phone number for confirmation.":"يرجى إدخال رقم الهاتف للتأكيد.");
            }

            if(phoneInput.value.length < 9) return notify("Phone Invalid");

            const btn = document.getElementById('checkoutBtn');
            btn.disabled = true; btn.innerText = "...";

            const orderStr = cart.map(i => `${i.name} (${i.quality}) x${i.qty}`).join(' | ');
            document.getElementById('hiddenOrderData').value = orderStr;
            document.getElementById('hiddenUserEmail').value = currentUser.email;
            document.getElementById('hiddenUserPhone').value = phoneInput.value;
            document.getElementById('hiddenDiscount').value = discountRate < 1 ? "15% OFF (3mk)" : "None";

            try {
                await fetch(e.target.action, { method: 'POST', body: new FormData(e.target), headers: {'Accept': 'application/json'} });
                await updateDoc(doc(db, "users", currentUser.uid), {
                    history: arrayUnion({ date: new Date().toLocaleString(), details: orderStr + (discountRate < 1 ? " [DISCOUNTED]" : "") }),
                    cart: []
                });

                notify(currentLang==='en' 
                    ? "Your order was submitted! We will check your order, check your interest in your order and start working on it!"
                    : "تم إرسال طلبك بنجاح! سنقوم بمراجعة الطلب والتحقق من اهتمامك والبدء في العمل عليه!");
                
                cart = []; updateCartUI(); closeModals();
                section.style.display = 'none'; phoneInput.value = '';
                syncData();
            } catch (err) { notify("Submission Error"); } finally { btn.disabled = false; btn.innerText = "FINALIZE ORDER"; }
        };

        function renderHistory(history) {
            const cont = document.getElementById('historyContent');
            cont.innerHTML = history.length ? "" : "<p style='color:#333; text-align:center;'>NO PREVIOUS LOGS</p>";
            [...history].reverse().forEach(h => {
                cont.innerHTML += `<div class="history-card"><div class="history-date">${h.date}</div><div style="font-size:0.85rem; color:#777; line-height:1.5;">${h.details}</div></div>`;
            });
        }

        // --- UI ---
        window.togglePanel = (id) => { closeModals(); document.getElementById(id).classList.add('open'); };
        window.closeModals = () => document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open'));
        window.toggleLang = () => {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            document.body.className = currentLang;
            document.querySelectorAll('[data-en]').forEach(el => el.innerText = el.getAttribute('data-'+currentLang));
            document.querySelectorAll('[data-en-p]').forEach(el => el.placeholder = el.getAttribute('data-'+currentLang+'-p'));
            renderProducts(); updateCartUI();
        };
    </script>
</body>
</html>
