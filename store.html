<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIYADUINO | Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Plus+Jakarta+Sans:wght@300;400;600&family=IBM+Plex+Sans+Arabic:wght@300;400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        /* --- THEME STYLES --- */
        :root {
            --bg-deep: #050505;
            --bg-panel: #0E0E0E;
            --gold-primary: #FFD700;
            --gold-glow: rgba(255, 215, 0, 0.4);
            --text-white: #ffffff;
            --text-grey: #b0b0b0;
            --border-tech: 1px solid rgba(255, 255, 255, 0.15);
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --font-arabic-body: 'IBM Plex Sans Arabic', sans-serif;
            --font-tech: 'Orbitron', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background-color: var(--bg-deep); 
            color: var(--text-white); 
            font-family: var(--font-main); 
            position: relative; 
            overflow-x: hidden;
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* --- NOTIFICATIONS (RIYADUINO SAYS) --- */
        #notification-area {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 3000; display: flex; flex-direction: column; gap: 10px;
            pointer-events: none; width: 90%; max-width: 400px;
        }
        .notify-toast {
            background: rgba(14, 14, 14, 0.95);
            border: 1px solid var(--gold-primary);
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            font-family: var(--font-tech);
            font-size: 0.85rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            animation: slideDown 0.3s ease-out;
            pointer-events: auto;
            display: flex; align-items: center; justify-content: space-between;
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Navigation */
        nav {
            position: sticky; top: 0; 
            background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(10px);
            border-bottom: var(--border-tech); padding: 15px 5%;
            display: flex; justify-content: space-between; align-items: center; z-index: 1000;
        }

        .logo { font-family: var(--font-tech); font-weight: 800; font-size: 1.5rem; color: #fff; text-decoration: none; letter-spacing: 1px; }
        .logo span { color: var(--gold-primary); text-shadow: 0 0 10px var(--gold-glow); }
        
        .nav-links { display: flex; align-items: center; gap: 20px; }
        
        /* Auth Button */
        .auth-btn-wrapper { position: relative; display: flex; align-items: center; gap: 10px; }
        .google-auth-btn {
            display: flex; align-items: center; gap: 10px;
            background: #fff; color: #111; border: none;
            padding: 8px 16px; border-radius: 4px; cursor: pointer;
            font-weight: 700; font-size: 0.8rem; font-family: var(--font-main);
            transition: all 0.3s ease;
        }
        .google-auth-btn:hover { background: #f1f1f1; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255,255,255,0.1); }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--gold-primary); display: none; }
        .google-icon { width: 18px; height: 18px; }

        .cart-trigger { cursor: pointer; position: relative; padding: 5px; }
        .cart-count { 
            position: absolute; top: -5px; right: -5px; background: var(--gold-primary); color: #000; 
            font-size: 0.7rem; font-weight: bold; width: 18px; height: 18px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
        }

        /* Container */
        .container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; flex-grow: 1; width: 100%; }
        
        /* Tabs */
        .filter-tabs { display: flex; justify-content: center; gap: 20px; margin-bottom: 50px; }
        .filter-btn {
            background: transparent; border: 1px solid #333; color: #666;
            padding: 12px 30px; font-family: var(--font-tech); font-weight: 700; font-size: 0.9rem;
            cursor: pointer; border-radius: 4px; transition: all 0.3s ease; letter-spacing: 1px;
        }
        .filter-btn:hover { border-color: var(--gold-primary); color: #fff; }
        .filter-btn.active { background: var(--gold-primary); color: #000; border-color: var(--gold-primary); box-shadow: 0 0 20px var(--gold-glow); }

        /* Grid */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; }

        /* Product Card */
        .product-card {
            background: var(--bg-panel); border: var(--border-tech); border-radius: 8px; overflow: hidden;
            transition: all 0.3s ease; display: flex; flex-direction: column; cursor: pointer; position: relative;
        }
        .product-card:hover { border-color: var(--gold-primary); transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .img-box { height: 220px; width: 100%; background: #111; overflow: hidden; position: relative; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .product-card:hover .img-box img { transform: scale(1.05); }
        
        .status-badge { 
            position: absolute; top: 10px; right: 10px; padding: 4px 10px; 
            font-size: 0.65rem; font-weight: 800; border-radius: 2px; letter-spacing: 0.5px; z-index: 2;
        }
        .in-stock-badge { background: #00ff41; color: #000; }
        .out-stock-badge { background: #ff003c; color: #fff; }

        .p-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .p-title { font-family: var(--font-main); font-weight: 600; margin-bottom: 5px; font-size: 1rem; color: #e0e0e0; }
        .p-price { color: var(--gold-primary); font-family: var(--font-tech); font-weight: 700; font-size: 1.1rem; margin-top: auto; }

        /* Product Detail Popup (Modal) */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }

        .detail-modal { 
            background: #111; width: 90%; max-width: 900px; display: grid; grid-template-columns: 1fr 1fr; 
            border: 1px solid #333; border-radius: 12px; overflow: hidden; max-height: 85vh;
        }
        .detail-img { width: 100%; height: 100%; object-fit: cover; background: #000; min-height: 300px; }
        .detail-content { padding: 40px; overflow-y: auto; display: flex; flex-direction: column; }
        .detail-title { font-family: var(--font-tech); font-size: 2rem; color: #fff; margin-bottom: 10px; }
        .detail-price { color: var(--gold-primary); font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; font-family: var(--font-tech); }
        .detail-desc { color: #aaa; line-height: 1.6; margin-bottom: 30px; font-size: 0.95rem; }
        
        .quality-selector { margin-bottom: 25px; }
        .quality-label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 8px; font-weight: 700; }
        .quality-options { display: flex; gap: 10px; }
        .q-opt { 
            flex: 1; padding: 10px; border: 1px solid #333; color: #888; text-align: center; cursor: pointer; border-radius: 4px; font-weight: 600; font-size: 0.85rem;
        }
        .q-opt.selected { border-color: var(--gold-primary); color: var(--gold-primary); background: rgba(255, 215, 0, 0.05); }

        .add-btn { 
            width: 100%; padding: 15px; background: var(--gold-primary); color: #000; border: none; 
            font-weight: 800; cursor: pointer; border-radius: 4px; font-family: var(--font-tech); font-size: 1rem; 
            transition: 0.2s;
        }
        .add-btn:hover { background: #e5c100; transform: scale(1.02); }

        /* Cart Sidebar */
        .cart-modal-content { 
            background: #0f0f0f; width: 95%; max-width: 500px; height: 100%; max-height: 100vh; margin-left: auto; 
            border-left: 1px solid #333; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s;
        }
        .modal-overlay.open .cart-modal-content { transform: translateX(0); }
        
        .cart-header { padding: 25px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .cart-header h2 { font-family: var(--font-tech); font-size: 1.2rem; }
        .close-cart { cursor: pointer; font-size: 1.5rem; color: #666; transition: 0.2s; }
        .close-cart:hover { color: #fff; }

        .cart-items { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .cart-item { display: flex; gap: 15px; padding-bottom: 20px; margin-bottom: 20px; border-bottom: 1px solid #1a1a1a; }
        .cart-item-img { width: 70px; height: 70px; border-radius: 4px; object-fit: cover; background: #222; }
        .cart-item-details { flex-grow: 1; }
        .ci-name { font-weight: 600; margin-bottom: 5px; font-size: 0.95rem; }
        .ci-quality { font-size: 0.75rem; color: #666; margin-bottom: 8px; text-transform: uppercase; }
        .ci-price { color: var(--gold-primary); font-weight: 700; font-size: 0.9rem; }
        
        .qty-control { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
        .qty-btn { width: 24px; height: 24px; background: #222; border: none; color: #fff; cursor: pointer; border-radius: 3px; font-weight: bold; }
        .qty-btn:hover { background: #333; }
        .qty-val { font-size: 0.9rem; width: 20px; text-align: center; }

        .cart-footer { padding: 25px; border-top: 1px solid #222; background: #0a0a0a; }
        .cart-total { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 1.1rem; font-weight: 700; }
        .checkout-btn { width: 100%; padding: 15px; background: #fff; color: #000; border: none; font-weight: 800; cursor: pointer; font-family: var(--font-tech); border-radius: 4px; }
        .checkout-btn:hover { background: var(--gold-primary); }

        /* Responsive */
        @media (max-width: 768px) {
            .detail-modal { grid-template-columns: 1fr; width: 95%; max-height: 90vh; display: flex; flex-direction: column; }
            .detail-img { height: 200px; flex-shrink: 0; }
            .container { padding: 20px 15px; }
        }
        
        body.rtl { direction: rtl; text-align: right; }
        body.rtl .cart-modal-content { margin-left: 0; margin-right: auto; border-left: none; border-right: 1px solid #333; transform: translateX(-100%); }
        body.rtl .modal-overlay.open .cart-modal-content { transform: translateX(0); }
    </style>
</head>
<body class="en">

    <div id="notification-area"></div>

    <nav>
        <a href="index.html" class="logo">RIYAD<span>UINO</span></a>
        
        <div class="nav-links">
            <button class="lang-btn filter-btn" style="padding: 5px 15px; font-size: 0.7rem;" onclick="toggleLang()">EN/AR</button>
            
            <div class="auth-btn-wrapper">
                <button id="googleAuthBtn" class="google-auth-btn" onclick="handleAuth()">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/button/google.svg" class="google-icon" alt="G">
                    <span id="authText" data-en="Sign In" data-ar="دخول">Sign In</span>
                </button>
                <img id="userAvatar" class="user-avatar" src="" alt="User">
            </div>

            <div class="cart-trigger" onclick="toggleCart()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                <div class="cart-count" id="cartCount">0</div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="filter-tabs">
            <button class="filter-btn active" onclick="setCategory('pieces')" data-en="PIECES" data-ar="قطع">PIECES</button>
            <button class="filter-btn" onclick="setCategory('projects')" data-en="PROJECTS" data-ar="مشاريع">PROJECTS</button>
        </div>

        <div id="loader" style="text-align:center; color: var(--gold-primary); font-family: var(--font-tech);">INITIALIZING DATABASE...</div>
        <div class="products-grid" id="productsGrid"></div>
    </div>

    <div class="modal-overlay" id="productModal" onclick="closeProductModal(event)">
        <div class="detail-modal" onclick="event.stopPropagation()">
            <img id="modalImg" class="detail-img" src="" alt="">
            <div class="detail-content">
                <h2 id="modalTitle" class="detail-title">Product Name</h2>
                <div id="modalPrice" class="detail-price">$0.00</div>
                <p id="modalDesc" class="detail-desc">Description goes here...</p>
                
                <div class="quality-selector">
                    <label class="quality-label" data-en="SELECT QUALITY" data-ar="اختر الجودة">SELECT QUALITY</label>
                    <div class="quality-options">
                        <div class="q-opt selected" onclick="selectQuality('Mid')" id="qMid" data-en="Mid Quality" data-ar="جودة متوسطة">Mid Quality</div>
                        <div class="q-opt" onclick="selectQuality('High')" id="qHigh" data-en="High Quality (+20%)" data-ar="جودة عالية (+20%)">High Quality (+20%)</div>
                    </div>
                </div>

                <button id="modalAddBtn" class="add-btn" data-en="ADD TO CART" data-ar="أضف للسلة">ADD TO CART</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cartModal" onclick="toggleCart()">
        <div class="cart-modal-content" onclick="event.stopPropagation()">
            <div class="cart-header">
                <h2 data-en="SHOPPING CART" data-ar="سلة التسوق">SHOPPING CART</h2>
                <span class="close-cart" onclick="toggleCart()">&times;</span>
            </div>
            
            <div id="cartItemsList" class="cart-items">
                </div>

            <div class="cart-footer">
                <div class="cart-total">
                    <span data-en="Total" data-ar="المجموع">Total</span>
                    <span id="cartTotalDisplay">$0.00</span>
                </div>
                <form action="https://formspree.io/f/xzzkyzzp" method="POST" id="orderForm" onsubmit="return validateAndSubmit(event)">
                    <input type="hidden" name="Order Details" id="hiddenOrderData">
                    <input type="hidden" name="user_email" id="hiddenUserEmail">
                    <button type="submit" class="checkout-btn" data-en="CHECKOUT NOW" data-ar="إتمام الشراء">CHECKOUT NOW</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCSLy3xjL78iCWG9jLPTAIvi3-TJBPfsjw",
            authDomain: "riyaduino-sign-in-database.firebaseapp.com",
            projectId: "riyaduino-sign-in-database",
            storageBucket: "riyaduino-sign-in-database.firebasestorage.app",
            messagingSenderId: "783217624924",
            appId: "1:783217624924:web:183c079062776d3d06a399",
            measurementId: "G-GKFL5P02D5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let currentLang = 'en';
        let allProducts = [];
        let cart = []; // Array of objects: { id, name, basePrice, finalPrice, qty, quality, image }
        let currentCategory = 'pieces';
        let selectedQuality = 'Mid';
        let currentProductIndex = null;

        // --- NOTIFICATION SYSTEM (RIYADUINO SAYS) ---
        window.notify = (msg, type='info') => {
            const area = document.getElementById('notification-area');
            const toast = document.createElement('div');
            toast.className = 'notify-toast';
            toast.innerHTML = `<span>RIYADUINO SAYS:</span> <span style="color:#ccc; margin-left:10px;">${msg}</span>`;
            area.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        // --- AUTH & DATABASE ---
        window.handleAuth = async () => {
            if (currentUser) {
                await signOut(auth);
                cart = []; // Clear cart on logout
                updateCartUI();
                window.notify(currentLang==='en'?"Logged out successfully":"تم تسجيل الخروج بنجاح");
            } else {
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Auth Error:", error);
                    window.notify("Login Failed", "error");
                }
            }
        };

        // Save cart to Firestore
        const saveCartToDB = async () => {
            if (!currentUser) return;
            try {
                await setDoc(doc(db, "carts", currentUser.uid), { items: cart });
            } catch (e) { console.error("Error saving cart", e); }
        };

        // Load cart from Firestore
        const loadCartFromDB = async () => {
            if (!currentUser) return;
            const docRef = doc(db, "carts", currentUser.uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                cart = docSnap.data().items || [];
                updateCartUI();
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const authText = document.getElementById('authText');
            const googleBtn = document.getElementById('googleAuthBtn');
            const avatar = document.getElementById('userAvatar');

            if (user) {
                authText.innerText = currentLang === 'en' ? "Sign Out" : "خروج";
                avatar.src = user.photoURL;
                avatar.style.display = "block";
                googleBtn.style.padding = "8px 12px"; 
                document.querySelector('.google-icon').style.display = 'none';
                loadCartFromDB(); // LOAD CART
                window.notify(`${currentLang==='en'?'Welcome back':'أهلاً بك'}, ${user.displayName.split(' ')[0]}`);
            } else {
                authText.innerText = currentLang === 'en' ? "Sign In" : "دخول";
                avatar.style.display = "none";
                document.querySelector('.google-icon').style.display = 'block';
            }
        });

        // --- STORE LOGIC ---
        const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTBQd3LUgZKxeuRQA2B0Cj3IvJBSSS0VL2vnmtOryQxFsAK-Kikg_NZTVGtlYghB96yFYyvqXrPGJEu/pub?output=csv";

        window.loadProducts = () => {
            Papa.parse(sheetURL, {
                download: true, header: true,
                complete: (results) => {
                    allProducts = results.data;
                    renderProducts();
                    document.getElementById('loader').style.display = 'none';
                }
            });
        };

        window.setCategory = (category) => {
            currentCategory = category;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerText.toLowerCase().includes(category) || btn.getAttribute('data-en').toLowerCase().includes(category)) {
                    btn.classList.add('active');
                }
            });
            renderProducts();
        };

        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = "";
            const filtered = allProducts.filter(p => {
                if(!p.name) return false;
                const pCat = p.category ? p.category.toLowerCase().trim() : 'pieces';
                return pCat === currentCategory;
            });

            if(filtered.length === 0) {
                grid.innerHTML = `<div style="text-align:center; grid-column:1/-1; color:#555;">No items found.</div>`;
                return;
            }

            filtered.forEach((p) => {
                const originalIndex = allProducts.indexOf(p);
                const isStock = p.instock?.toUpperCase() === 'TRUE';
                
                grid.innerHTML += `
                    <div class="product-card" onclick="openProductModal(${originalIndex})">
                        <div class="img-box">
                            <img src="${p.image || 'https://placehold.co/400x300?text=No+Image'}" loading="lazy">
                            <div class="status-badge ${isStock?'in-stock-badge':'out-stock-badge'}">${isStock?'IN STOCK':'SOLD OUT'}</div>
                        </div>
                        <div class="p-info">
                            <div class="p-title">${p.name}</div>
                            <div class="p-price">${p.price}</div>
                        </div>
                    </div>`;
            });
        }

        // --- PRODUCT MODAL & QUALITY ---
        window.openProductModal = (index) => {
            const p = allProducts[index];
            if(p.instock?.toUpperCase() !== 'TRUE') {
                window.notify(currentLang==='en'?"Item is out of stock":"نفذت الكمية");
                return;
            }

            currentProductIndex = index;
            document.getElementById('modalImg').src = p.image || 'https://placehold.co/400x300';
            document.getElementById('modalTitle').innerText = p.name;
            document.getElementById('modalPrice').innerText = p.price;
            document.getElementById('modalDesc').innerText = p.description || (currentLang==='en'?"No description available.":"لا يوجد وصف.");
            
            // Reset Quality
            selectQuality('Mid');
            
            const modal = document.getElementById('productModal');
            modal.classList.add('open');
            
            // Setup Add Button
            document.getElementById('modalAddBtn').onclick = () => {
                addToCart(index, selectedQuality);
                closeProductModal();
            };
        };

        window.closeProductModal = () => {
            document.getElementById('productModal').classList.remove('open');
        };

        window.selectQuality = (q) => {
            selectedQuality = q;
            document.querySelectorAll('.q-opt').forEach(el => el.classList.remove('selected'));
            document.getElementById('q' + q).classList.add('selected');
        };

        // --- CART LOGIC ---
        window.addToCart = (index, quality) => {
            const p = allProducts[index];
            // Price Calculation (remove '$', multiply if high quality)
            let basePriceNum = parseFloat(p.price.replace(/[^0-9.]/g, ''));
            let finalPriceNum = quality === 'High' ? basePriceNum * 1.20 : basePriceNum;
            let finalPriceStr = "$" + finalPriceNum.toFixed(2);

            // Check if exact item exists
            const existing = cart.find(x => x.id === index && x.quality === quality);
            
            if(existing) {
                existing.qty++;
            } else {
                cart.push({
                    id: index,
                    name: p.name,
                    basePrice: p.price,
                    finalPrice: finalPriceStr,
                    qty: 1,
                    quality: quality,
                    image: p.image || 'https://placehold.co/100'
                });
            }
            
            updateCartUI();
            saveCartToDB();
            window.notify(currentLang==='en'?"Added to cart":"تمت الإضافة للسلة");
            toggleCart(true); // Open cart to show user
        };

        window.changeQty = (cartIndex, delta) => {
            cart[cartIndex].qty += delta;
            if(cart[cartIndex].qty <= 0) {
                cart.splice(cartIndex, 1);
            }
            updateCartUI();
            saveCartToDB();
        };

        function updateCartUI() {
            document.getElementById('cartCount').innerText = cart.reduce((s, x) => s + x.qty, 0);
            
            const list = document.getElementById('cartItemsList');
            list.innerHTML = "";
            
            let total = 0;

            if(cart.length === 0) {
                list.innerHTML = `<div style="text-align:center; color:#555; margin-top:50px;">${currentLang==='en'?'Cart is empty':'السلة فارغة'}</div>`;
            } else {
                cart.forEach((item, idx) => {
                    let itemTotal = parseFloat(item.finalPrice.replace('$','')) * item.qty;
                    total += itemTotal;

                    list.innerHTML += `
                        <div class="cart-item">
                            <img src="${item.image}" class="cart-item-img">
                            <div class="cart-item-details">
                                <div class="ci-name">${item.name}</div>
                                <div class="ci-quality">${item.quality} Quality</div>
                                <div class="ci-price">${item.finalPrice}</div>
                                <div class="qty-control">
                                    <button class="qty-btn" onclick="changeQty(${idx}, -1)">-</button>
                                    <span class="qty-val">${item.qty}</span>
                                    <button class="qty-btn" onclick="changeQty(${idx}, 1)">+</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('cartTotalDisplay').innerText = "$" + total.toFixed(2);
        }

        window.toggleCart = (forceOpen = false) => {
            const m = document.getElementById('cartModal');
            const isOpen = m.classList.contains('open');
            if(forceOpen) m.classList.add('open');
            else if(isOpen) m.classList.remove('open');
            else m.classList.add('open');
        };

        // --- TRANSLATION ---
        window.toggleLang = () => {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            document.body.className = currentLang;
            document.body.classList.toggle('rtl', currentLang === 'ar');
            document.querySelectorAll('[data-en]').forEach(el => el.innerText = el.getAttribute(`data-${currentLang}`));
            renderProducts();
            
            // Auth Text Update
            const authText = document.getElementById('authText');
            if (currentUser) {
                authText.innerText = currentLang === 'en' ? "Sign Out" : "خروج";
            } else {
                authText.innerText = currentLang === 'en' ? "Sign In" : "دخول";
            }
            updateCartUI();
        };

        window.validateAndSubmit = (e) => {
            if(!currentUser) {
                e.preventDefault();
                window.notify(currentLang==='en'?"Please Sign In first!":"يرجى تسجيل الدخول أولاً!", "error");
                handleAuth();
                return false;
            }
            if(!cart.length) { 
                e.preventDefault();
                window.notify(currentLang==='en'?"Cart is empty":"السلة فارغة", "error"); 
                return false; 
            }

            // Prepare Order String
            const orderSummary = cart.map(x => `[${x.name} | ${x.quality} | Qty:${x.qty}]`).join('\n');
            document.getElementById('hiddenOrderData').value = orderSummary;
            document.getElementById('hiddenUserEmail').value = currentUser.email;
            
            return true;
        };

        loadProducts();
    </script>
</body>
</html>
