<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIYADUINO | Professional Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Plus+Jakarta+Sans:wght@300;400;600&family=IBM+Plex+Sans+Arabic:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root {
            --bg-deep: #050505;
            --bg-panel: #0E0E0E;
            --gold-primary: #FFD700;
            --gold-glow: rgba(255, 215, 0, 0.4);
            --text-white: #ffffff;
            --text-grey: #b0b0b0;
            --border-tech: 1px solid rgba(255, 255, 255, 0.15);
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --font-arabic-body: 'IBM Plex Sans Arabic', sans-serif;
            --font-tech: 'Orbitron', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background-color: var(--bg-deep); color: var(--text-white); 
            font-family: var(--font-main); overflow-x: hidden;
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* =========================================
           STRICT ARABIC FONT ENFORCEMENT
           ========================================= */
        body.ar { 
            direction: rtl; 
            text-align: right;
        }

        /* 1. UNIVERSAL OVERRIDE: 
           Force EVERY element inside body.ar to use the Arabic font. */
        body.ar * {
            font-family: var(--font-arabic-body) !important;
        }

        /* 2. SPECIFIC OVERRIDES FOR TECH ELEMENTS:
           Force elements that usually use 'Orbitron' (Logo, Prices, Buttons) 
           to switch to Arabic font when in Arabic mode. */
        body.ar h1, 
        body.ar h2, 
        body.ar h3, 
        body.ar .logo, 
        body.ar .p-price, 
        body.ar .coupon-strap,
        body.ar .filter-btn,
        body.ar .btn-gold,
        body.ar .notify-toast,
        body.ar .badge {
            font-family: var(--font-arabic-body) !important; 
            font-weight: 700 !important; 
            letter-spacing: 0 !important; 
        }

        body.ar .sidebar-panel { margin-left: 0; margin-right: auto; border-left: none; border-right: 1px solid #222; }
        
        /* 3. INPUTS & PLACEHOLDERS */
        body.ar input, 
        body.ar input::placeholder,
        body.ar textarea::placeholder {
            font-family: var(--font-arabic-body) !important;
        }

        /* --- COUPON TICKER --- */
        .coupon-strap {
            background: var(--gold-primary); color: #000;
            padding: 10px 0; font-family: var(--font-tech); font-weight: 900;
            font-size: 0.85rem; overflow: hidden; white-space: nowrap;
            position: relative; z-index: 1001; box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }
        .ticker-text {
            display: inline-block; animation: ticker 30s linear infinite;
            padding-left: 100%;
        }
        @keyframes ticker {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }
        .code-fix { direction: ltr; display: inline-block; unicode-bidi: isolate; background: rgba(0,0,0,0.1); padding: 0 5px; border-radius: 3px; }

        /* --- GOLD DUST PARTICLES --- */
        #particle-canvas {
            position: fixed; top: 0; left: 0; pointer-events: none;
            z-index: 9999; width: 100%; height: 100%;
        }

        /* RIYADUINO MESSAGES (TOASTS) */
        #notification-area {
            position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
            z-index: 5000; display: flex; flex-direction: column; gap: 10px;
            pointer-events: none; width: 90%; max-width: 450px;
        }
        .notify-toast {
            background: rgba(14, 14, 14, 0.98); border: 1px solid var(--gold-primary);
            color: #fff; padding: 15px 20px; border-radius: 8px; font-family: var(--font-tech);
            font-size: 0.85rem; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            animation: slideDown 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            pointer-events: auto; line-height: 1.4;
        }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Navigation */
        nav {
            position: sticky; top: 0; background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(10px);
            border-bottom: var(--border-tech); padding: 15px 5%;
            display: flex; justify-content: space-between; align-items: center; z-index: 1000;
        }
        .logo { font-family: var(--font-tech); font-weight: 800; font-size: 1.5rem; color: #fff; text-decoration: none; }
        .logo span { color: var(--gold-primary); text-shadow: 0 0 10px var(--gold-glow); }
        .nav-links { display: flex; align-items: center; gap: 15px; }

        /* Home Button Style */
        .home-btn {
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Auth & Profile */
        .google-auth-btn {
            display: flex; align-items: center; gap: 8px; background: #fff; color: #111; border: none;
            padding: 8px 14px; border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 0.8rem;
        }
        .user-avatar { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--gold-primary); cursor: pointer; display: none; }

        /* Icons */
        .icon-btn { cursor: pointer; position: relative; color: #fff; transition: 0.2s; }
        .icon-btn:hover { color: var(--gold-primary); }
        .badge { 
            position: absolute; top: -8px; right: -8px; background: var(--gold-primary); color: #000; 
            font-size: 0.65rem; font-weight: bold; padding: 2px 6px; border-radius: 10px;
        }

        /* Tabs */
        .container { max-width: 1300px; margin: 0 auto; padding: 40px 20px; flex-grow: 1; width: 100%; }
        .filter-tabs { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; }
        .filter-btn {
            background: transparent; border: 1px solid #333; color: #888; padding: 10px 25px;
            font-family: var(--font-tech); font-weight: 700; cursor: pointer; border-radius: 4px; transition: 0.3s;
        }
        .filter-btn.active { background: var(--gold-primary); color: #000; border-color: var(--gold-primary); }

        /* Grid */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .product-card {
            background: var(--bg-panel); border: var(--border-tech); border-radius: 12px; overflow: hidden;
            transition: 0.3s; cursor: pointer; position: relative;
        }
        .product-card:hover { border-color: var(--gold-primary); transform: translateY(-5px); }
        .img-box { height: 200px; background: #000; overflow: hidden; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; }
        .p-info { padding: 20px; }
        .p-title { font-weight: 600; font-size: 1.1rem; margin-bottom: 8px; }
        .p-price { color: var(--gold-primary); font-family: var(--font-tech); font-weight: 700; }

        /* Modals */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-overlay.open { display: flex; }

        .detail-modal { 
            background: #111; width: 90%; max-width: 850px; display: grid; grid-template-columns: 1.2fr 1fr; 
            border: var(--border-tech); border-radius: 15px; overflow: hidden;
        }
        .detail-content { padding: 30px; display: flex; flex-direction: column; justify-content: center; }
        .quality-options { display: flex; gap: 10px; margin: 15px 0; }
        .q-opt { 
            flex: 1; padding: 10px; border: 1px solid #333; text-align: center; cursor: pointer; 
            border-radius: 6px; font-size: 0.8rem; color: #888; transition: 0.2s;
        }
        .q-opt.selected { border-color: var(--gold-primary); color: var(--gold-primary); background: rgba(255,215,0,0.1); }

        /* Sidebar panels */
        .sidebar-panel { 
            background: #0a0a0a; width: 100%; max-width: 450px; height: 100%; margin-left: auto; 
            border-left: 1px solid #222; display: flex; flex-direction: column;
        }
        .panel-header { padding: 25px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; }
        .panel-content { flex-grow: 1; overflow-y: auto; padding: 20px; }

        /* Coupon UI in Cart */
        .coupon-box { display: flex; gap: 10px; margin-bottom: 15px; }
        #couponInput {
            flex: 1; background: #000; border: 1px solid #333; color: var(--gold-primary);
            padding: 10px; border-radius: 4px; outline: none; font-family: var(--font-tech);
        }
        .apply-btn { background: #222; color: #fff; border: none; padding: 0 15px; cursor: pointer; font-size: 0.75rem; border-radius: 4px; transition: 0.2s; font-family: var(--font-tech); }
        .apply-btn:hover { background: #333; color: var(--gold-primary); }

        .cart-item { display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #1a1a1a; padding-bottom: 15px; }
        .cart-item img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        .qty-ctrl { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
        .qty-btn { background: #222; border: none; color: #fff; width: 25px; height: 25px; cursor: pointer; border-radius: 4px; }
        
        .history-card { background: #151515; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #222; }
        .history-date { font-size: 0.7rem; color: var(--gold-primary); font-family: var(--font-tech); margin-bottom: 5px; }

        #userPhone {
            width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; 
            border-radius: 6px; outline: none; transition: 0.3s; font-size: 1rem;
        }
        #userPhone:focus { border-color: var(--gold-primary); }

        .btn-gold { 
            width: 100%; padding: 15px; background: var(--gold-primary); color: #000; border: none; 
            font-weight: 800; cursor: pointer; font-family: var(--font-tech); border-radius: 6px; transition: 0.2s;
        }

        @media (max-width: 768px) {
            .detail-modal { grid-template-columns: 1fr; }
            .img-box { height: 250px; }
        }
    </style>
</head>
<body class="en">

    <div class="coupon-strap">
        <div class="ticker-text">
            USE CODE: <bdi class="code-fix">3mk</bdi> FOR 15% OFF YOUR ORDER — استخدم الكود <bdi class="code-fix">3mk</bdi> للحصول على خصم 15% على طلبك — 
            USE CODE: <bdi class="code-fix">3mk</bdi> FOR 15% OFF YOUR ORDER — استخدم الكود <bdi class="code-fix">3mk</bdi> للحصول على خصم 15% على طلبك —
        </div>
    </div>

    <canvas id="particle-canvas"></canvas>
    <div id="notification-area"></div>

    <nav>
        <a href="#" class="logo" onclick="location.reload()">RIYAD<span>UINO</span></a>
        <div class="nav-links">
            <a href="index.html" class="filter-btn home-btn" style="padding: 5px 10px;" data-en="HOME" data-ar="الرئيسية">HOME</a>
            
            <button class="filter-btn" style="padding: 5px 10px;" onclick="toggleLang()">EN/AR</button>
            <div class="icon-btn" onclick="togglePanel('historyModal')">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
            <div class="icon-btn" onclick="togglePanel('cartModal')">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                <div class="badge" id="cartCount">0</div>
            </div>
            <div class="auth-btn-wrapper">
                <button id="googleAuthBtn" class="google-auth-btn" onclick="handleAuth()">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/button/google.svg" width="18">
                    <span id="authText" data-en="Sign In" data-ar="دخول">Sign In</span>
                </button>
                <img id="userAvatar" class="user-avatar" onclick="handleAuth()">
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="filter-tabs">
            <button class="filter-btn active" onclick="setCategory('pieces')" data-en="PIECES" data-ar="القطع">PIECES</button>
            <button class="filter-btn" onclick="setCategory('projects')" data-en="PROJECTS" data-ar="المشاريع">PROJECTS</button>
        </div>
        <div id="loader" style="text-align:center; color:var(--gold-primary); font-family:var(--font-tech);">INITIALIZING RIYADUINO...</div>
        <div class="products-grid" id="productsGrid"></div>
    </div>

    <div class="modal-overlay" id="productModal" onclick="closeModals()">
        <div class="detail-modal" onclick="event.stopPropagation()">
            <img id="modalImg" style="width:100%; height:100%; object-fit:cover;">
            <div class="detail-content">
                <h2 id="modalTitle" style="font-family:var(--font-tech); margin-bottom:10px;"></h2>
                <div id="modalPrice" style="color:var(--gold-primary); font-size:1.5rem; font-weight:700; margin-bottom:15px; font-family:var(--font-tech);"></div>
                <p id="modalDesc" style="color:#888; font-size:0.9rem; line-height:1.6; margin-bottom:20px;"></p>
                <div class="quality-selector">
                    <label style="font-size:0.7rem; color:#555; font-weight:bold;" data-en="SELECT QUALITY" data-ar="اختر الجودة">SELECT QUALITY</label>
                    <div class="quality-options">
                        <div class="q-opt selected" onclick="selectQuality('Mid')" id="qMid" data-en="Mid" data-ar="متوسطة">Mid</div>
                        <div class="q-opt" onclick="selectQuality('High')" id="qHigh" data-en="High (+20%)" data-ar="عالية (+20%)">High</div>
                    </div>
                </div>
                <button id="modalAddBtn" class="btn-gold" data-en="ADD TO CART" data-ar="إضافة للسلة">ADD TO CART</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cartModal" onclick="closeModals()">
        <div class="sidebar-panel" onclick="event.stopPropagation()">
            <div class="panel-header">
                <h2 data-en="SHOPPING CART" data-ar="سلة التسوق">SHOPPING CART</h2>
                <span style="cursor:pointer; font-size:1.5rem" onclick="closeModals()">✕</span>
            </div>
            <div id="cartItemsList" class="panel-content"></div>
            <div style="padding:25px; border-top:1px solid #222; background:#050505;">
                <div class="coupon-box">
                    <input type="text" id="couponInput" placeholder="Coupon Code" data-en-p="Coupon Code" data-ar-p="كود الخصم">
                    <button class="apply-btn" onclick="applyCoupon()" data-en="APPLY" data-ar="تطبيق">APPLY</button>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-weight:700; font-size:1.2rem;">
                    <span data-en="Total" data-ar="المجموع">Total</span>
                    <span id="cartTotalDisplay" style="color:var(--gold-primary)">$0.00</span>
                </div>
                <div id="phoneInputSection" style="display:none; margin-bottom:15px;">
                    <label style="font-size:0.75rem; color:var(--gold-primary); margin-bottom:5px; display:block;" data-en="Real Phone Number (WhatsApp preferred):" data-ar="رقم هاتف حقيقي (يفضل واتساب):">Real Phone Number:</label>
                    <input type="tel" id="userPhone" placeholder="05xxxxxxxx" maxlength="15">
                </div>
                <form action="https://formspree.io/f/xzzkyzzp" method="POST" id="orderForm" onsubmit="validateAndSubmit(event)">
                    <input type="hidden" name="Order_Summary" id="hiddenOrderData">
                    <input type="hidden" name="User_Email" id="hiddenUserEmail">
                    <input type="hidden" name="User_Phone" id="hiddenUserPhone">
                    <button type="submit" id="checkoutBtn" class="btn-gold" data-en="CHECKOUT NOW" data-ar="إتمام الشراء">CHECKOUT NOW</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="historyModal" onclick="closeModals()">
        <div class="sidebar-panel" onclick="event.stopPropagation()">
            <div class="panel-header">
                <h2 data-en="MY ORDERS" data-ar="طلباتي">MY ORDERS</h2>
                <span style="cursor:pointer; font-size:1.5rem" onclick="closeModals()">✕</span>
            </div>
            <div id="historyContent" class="panel-content"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCSLy3xjL78iCWG9jLPTAIvi3-TJBPfsjw",
            authDomain: "riyaduino-sign-in-database.firebaseapp.com",
            projectId: "riyaduino-sign-in-database",
            storageBucket: "riyaduino-sign-in-database.firebasestorage.app",
            messagingSenderId: "783217624924",
            appId: "1:783217624924:web:183c079062776d3d06a399"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null, currentLang = 'en', allProducts = [], cart = [], selectedQuality = 'Mid', discount = 1.0;

        // --- NEW GOLD DUST PARTICLES ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = canvas.height + 20;
                this.size = Math.random() * 3 + 1;
                this.speedY = Math.random() * -4 - 2;
                this.speedX = (Math.random() - 0.5) * 3;
                this.gravity = 0.05;
                this.opacity = 1;
                this.rotation = Math.random() * Math.PI;
            }
            update() {
                this.y += this.speedY;
                this.x += this.speedX;
                this.speedY += this.gravity;
                this.opacity -= 0.007;
                this.rotation += 0.1;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                ctx.fillStyle = `rgba(255, 215, 0, ${this.opacity})`;
                ctx.shadowBlur = 10;
                ctx.shadowColor = "gold";
                ctx.fillRect(-this.size/2, -this.size/2, this.size, this.size);
                ctx.restore();
            }
        }

        function triggerParticles() {
            particles = Array.from({length: 120}, () => new Particle());
            function animate() {
                ctx.clearRect(0,0,canvas.width, canvas.height);
                particles.forEach((p, i) => {
                    p.update(); p.draw();
                    if(p.opacity <= 0 || p.y > canvas.height + 50) particles.splice(i, 1);
                });
                if(particles.length > 0) requestAnimationFrame(animate);
            }
            animate();
        }

        window.applyCoupon = () => {
            if(document.getElementById('couponInput').value.trim().toLowerCase() === '3mk') {
                discount = 0.85; triggerParticles();
                notify(currentLang === 'en' ? "COUPON ACTIVATED! 15% OFF" : "تم تفعيل الخصم! 15%");
                updateCartUI();
            } else notify(currentLang === 'en' ? "Invalid Code" : "كود غير صالح");
        };

        window.notify = (msg) => {
            const area = document.getElementById('notification-area');
            const t = document.createElement('div');
            t.className = 'notify-toast';
            t.innerHTML = `<strong>RIYADUINO SYSTEM:</strong><br>${msg}`;
            area.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 400); }, 5000);
        };

        window.handleAuth = async () => { if (currentUser) await signOut(auth); else await signInWithPopup(auth, provider); };

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const avatar = document.getElementById('userAvatar'), authBtn = document.getElementById('googleAuthBtn');
            if (user) {
                avatar.src = user.photoURL; avatar.style.display = 'block'; authBtn.style.display = 'none';
                await syncUserData();
            } else { avatar.style.display = 'none'; authBtn.style.display = 'flex'; cart = []; updateCartUI(); }
        });

        async function syncUserData() {
            const ref = doc(db, "users", currentUser.uid), snap = await getDoc(ref);
            if (snap.exists()) { cart = snap.data().cart || []; renderHistory(snap.data().history || []); }
            else await setDoc(ref, { cart: [], history: [] });
            updateCartUI();
        }

        const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTBQd3LUgZKxeuRQA2B0Cj3IvJBSSS0VL2vnmtOryQxFsAK-Kikg_NZTVGtlYghB96yFYyvqXrPGJEu/pub?output=csv";
        Papa.parse(sheetURL, { download: true, header: true, complete: (res) => { allProducts = res.data; document.getElementById('loader').style.display = 'none'; renderProducts(); } });

        window.setCategory = (cat) => { document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); renderProducts(cat); };
        function renderProducts(cat = 'pieces') {
            const grid = document.getElementById('productsGrid'); grid.innerHTML = "";
            allProducts.filter(p => (p.category || 'pieces').toLowerCase() === cat).forEach((p, i) => {
                grid.innerHTML += `<div class="product-card" onclick="openProduct(${allProducts.indexOf(p)})"><div class="img-box"><img src="${p.image}"></div><div class="p-info"><div class="p-title">${p.name}</div><div class="p-price">${p.price}</div></div></div>`;
            });
        }

        window.openProduct = (idx) => {
            const p = allProducts[idx];
            if(p.instock?.toLowerCase() !== 'true') return notify(currentLang==='en'?"Out of Stock!":"نفذت الكمية!");
            document.getElementById('modalImg').src = p.image; document.getElementById('modalTitle').innerText = p.name;
            document.getElementById('modalPrice').innerText = p.price; document.getElementById('modalDesc').innerText = p.description || "...";
            selectQuality('Mid'); document.getElementById('productModal').classList.add('open');
            document.getElementById('modalAddBtn').onclick = () => addToCart(idx);
        };

        window.selectQuality = (q) => { selectedQuality = q; document.querySelectorAll('.q-opt').forEach(o => o.classList.remove('selected')); document.getElementById('q'+q).classList.add('selected'); };
        window.addToCart = (idx) => {
            const p = allProducts[idx]; let pNum = parseFloat(p.price.replace(/[^0-9.]/g, ''));
            if(selectedQuality === 'High') pNum *= 1.2;
            const ex = cart.find(i => i.idx === idx && i.quality === selectedQuality);
            if(ex) ex.qty++; else cart.push({ idx, name: p.name, price: pNum, qty: 1, quality: selectedQuality, img: p.image });
            updateCartUI(); updateDoc(doc(db, "users", currentUser.uid), { cart: cart }); closeModals();
        };

        window.updateCartUI = () => {
            const list = document.getElementById('cartItemsList'); let total = 0;
            list.innerHTML = cart.length ? "" : `<div style="text-align:center; padding:50px; color:#444;">${currentLang==='en'?'Cart is Empty':'السلة فارغة'}</div>`;
            cart.forEach((item, i) => {
                total += item.price * item.qty;
                list.innerHTML += `<div class="cart-item"><img src="${item.img}"><div style="flex:1"><div style="font-size:0.9rem; font-weight:600;">${item.name}</div><div style="font-size:0.7rem; color:#666;">${item.quality}</div><div class="qty-ctrl"><button class="qty-btn" onclick="changeQty(${i},-1)">-</button><span style="font-size:0.8rem">${item.qty}</span><button class="qty-btn" onclick="changeQty(${i},1)">+</button></div></div><div style="color:var(--gold-primary); font-weight:700;">$${(item.price * item.qty).toFixed(2)}</div></div>`;
            });
            document.getElementById('cartTotalDisplay').innerText = "$" + (total * discount).toFixed(2);
            document.getElementById('cartCount').innerText = cart.reduce((a, b) => a + b.qty, 0);
        };

        window.changeQty = (i, d) => { cart[i].qty += d; if(cart[i].qty <= 0) cart.splice(i, 1); updateCartUI(); updateDoc(doc(db, "users", currentUser.uid), { cart: cart }); };

        window.validateAndSubmit = async (e) => {
            e.preventDefault();
            if(!currentUser) return handleAuth();
            if(!cart.length) return;
            const sec = document.getElementById('phoneInputSection'), ph = document.getElementById('userPhone');
            if(sec.style.display === 'none') { sec.style.display = 'block'; ph.focus(); return notify(currentLang==='en'?"Almost there! We need your phone.":"خطوة أخيرة! نحتاج رقم هاتفك."); }
            
            // --- REAL PHONE VALIDATION ---
            const phoneRegex = /^(05|5|\+966|00966)[0-9]{8,11}$/;
            if(!phoneRegex.test(ph.value.replace(/\s/g, ''))) {
                ph.style.borderColor = "red";
                return notify(currentLang==='en'?"Please enter a real, valid phone number!":"يرجى إدخال رقم هاتف حقيقي وصحيح!");
            }

            const btn = document.getElementById('checkoutBtn'); btn.disabled = true; btn.innerText = "...";
            const orderStr = cart.map(i => `${i.name} (${i.quality}) x${i.qty}`).join(' | ') + (discount < 1 ? " [15% OFF]" : "");
            document.getElementById('hiddenOrderData').value = orderStr;
            document.getElementById('hiddenUserEmail').value = currentUser.email;
            document.getElementById('hiddenUserPhone').value = ph.value;

            try {
                const res = await fetch(e.target.action, { method: 'POST', body: new FormData(e.target), headers: {'Accept': 'application/json'} });
                if (res.ok) {
                    await updateDoc(doc(db, "users", currentUser.uid), { history: arrayUnion({ date: new Date().toLocaleString(), details: orderStr }), cart: [] });
                    notify(currentLang==='en' ? "Success! Order Logged." : "تم بنجاح! تم تسجيل طلبك.");
                    cart = []; updateCartUI(); closeModals(); ph.value = ''; sec.style.display = 'none'; syncUserData();
                }
            } catch (err) { notify("Error!"); } finally { btn.disabled = false; btn.innerText = currentLang==='en'?"CHECKOUT NOW":"إتمام الشراء"; }
        };

        function renderHistory(h) {
            const c = document.getElementById('historyContent'); c.innerHTML = h.length ? "" : `<p style='text-align:center; color:#444;'>No orders yet</p>`;
            [...h].reverse().forEach(o => { c.innerHTML += `<div class="history-card"><div class="history-date">${o.date}</div><div style="font-size:0.8rem; color:#888;">${o.details}</div></div>`; });
        }

        window.togglePanel = (id) => { closeModals(); document.getElementById(id).classList.add('open'); };
        window.closeModals = () => { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open')); };
        window.toggleLang = () => {
            currentLang = currentLang === 'en' ? 'ar' : 'en'; document.body.className = currentLang;
            document.querySelectorAll('[data-en]').forEach(el => el.innerText = el.getAttribute('data-'+currentLang));
            document.querySelectorAll('[data-en-p]').forEach(el => el.placeholder = el.getAttribute('data-'+currentLang+'-p'));
            renderProducts(); updateCartUI();
        };
    </script>
</body>
</html>
