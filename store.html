<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIYADUINO | Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Plus+Jakarta+Sans:wght@300;400;600&family=IBM+Plex+Sans+Arabic:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        /* --- THEME STYLES --- */
        :root {
            --bg-deep: #050505;
            --bg-panel: #0E0E0E;
            --gold-primary: #FFD700;
            --text-white: #ffffff;
            --text-grey: #999999;
            --border-tech: 1px solid rgba(255, 255, 255, 0.1);
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --font-arabic-body: 'IBM Plex Sans Arabic', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--bg-deep); color: var(--text-white); font-family: var(--font-main); overflow-x: hidden; }
        
        /* Navigation */
        nav {
            position: sticky; top: 15px; margin: 15px auto; max-width: 1200px; width: 92%;
            background: rgba(14, 14, 14, 0.9); backdrop-filter: blur(15px);
            border: var(--border-tech); border-radius: 15px; padding: 12px 25px;
            display: flex; justify-content: space-between; align-items: center; z-index: 1000;
        }
        .logo { font-family: 'Orbitron', sans-serif; font-weight: 800; font-size: 1.4rem; color: #fff; text-decoration: none; }
        .logo span { color: var(--gold-primary); }
        .nav-links { display: flex; align-items: center; gap: 20px; }
        .nav-links a { color: #fff; text-decoration: none; font-size: 0.75rem; font-weight: 700; transition: 0.3s; }
        .nav-links a:hover { color: var(--gold-primary); }

        /* Auth & Cart Buttons */
        .icon-btn { position: relative; cursor: pointer; color: #fff; font-size: 1.1rem; transition: 0.3s; background: none; border: none; }
        .icon-btn:hover { color: var(--gold-primary); }
        .cart-count { 
            position: absolute; top: -8px; right: -8px; background: var(--gold-primary); 
            color: #000; font-size: 0.6rem; font-weight: 900; padding: 2px 5px; border-radius: 50%;
        }
        .user-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 1px solid var(--gold-primary); display: none; cursor: pointer; }

        /* Store Layout */
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        .store-header { text-align: center; margin-bottom: 50px; }
        .store-header h1 { font-family: 'Orbitron', sans-serif; color: var(--gold-primary); font-size: 2.5rem; margin-bottom: 10px; }
        #loader { text-align: center; color: var(--gold-primary); font-family: 'Orbitron', sans-serif; margin-top: 50px; }

        /* Grid & Cards */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }
        .product-card {
            background: var(--bg-panel); border: var(--border-tech); border-radius: 15px; overflow: hidden;
            transition: 0.3s; display: flex; flex-direction: column;
        }
        .product-card:hover { transform: translateY(-5px); border-color: var(--gold-primary); }
        .img-box { height: 220px; width: 100%; background: #000; position: relative; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; }
        .status-badge {
            position: absolute; top: 10px; right: 10px; padding: 4px 10px; font-size: 0.7rem; font-weight: bold; border-radius: 4px; z-index: 2;
        }
        .in-stock-badge { background: #00ff41; color: #000; box-shadow: 0 0 10px rgba(0,255,65,0.4); }
        .out-stock-badge { background: #ff003c; color: #fff; box-shadow: 0 0 10px rgba(255,0,60,0.4); }
        .p-info { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .p-title { font-family: 'Orbitron', sans-serif; font-size: 1.1rem; margin-bottom: 8px; color: #fff; }
        .p-desc { color: var(--text-grey); font-size: 0.85rem; margin-bottom: 15px; flex-grow: 1; line-height: 1.5; }
        .p-price { font-size: 1.25rem; color: var(--gold-primary); font-weight: 700; margin-bottom: 15px; }
        .buy-btn {
            width: 100%; padding: 12px; border: none; font-weight: 700; cursor: pointer; border-radius: 6px; 
            font-family: 'Orbitron', sans-serif; letter-spacing: 1px; transition: 0.3s;
        }
        .buy-btn.active { background: #fff; color: #000; }
        .buy-btn.active:hover { background: var(--gold-primary); }
        .buy-btn.disabled { background: #222; color: #555; cursor: not-allowed; border: 1px solid #333; }

        /* --- MODALS --- */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); justify-content: center; align-items: center;
        }
        .modal-content {
            background: #111; border: 1px solid var(--gold-primary); padding: 30px; border-radius: 15px;
            width: 90%; max-width: 400px; position: relative;
        }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #fff; }
        
        /* Auth Form */
        .auth-btn { width: 100%; padding: 12px; margin-top: 10px; cursor: pointer; border-radius: 5px; font-weight: bold; border: none; font-family: var(--font-main); }
        .btn-google { background: #fff; color: #333; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-email { background: var(--gold-primary); color: #000; }
        .auth-input { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: #fff; margin-bottom: 10px; border-radius: 5px; }

        /* Cart Modal */
        .cart-items { max-height: 300px; overflow-y: auto; margin: 20px 0; border-top: 1px solid #333; border-bottom: 1px solid #333; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #222; }
        .cart-total { text-align: right; font-size: 1.2rem; color: var(--gold-primary); font-weight: bold; margin-bottom: 20px; }
        .checkout-btn { width: 100%; padding: 15px; background: var(--gold-primary); border: none; font-weight: 900; cursor: pointer; border-radius: 8px; font-family: 'Orbitron'; }
        
        .toast {
            position: fixed; bottom: 20px; right: 20px; background: var(--gold-primary); color: #000;
            padding: 15px 25px; border-radius: 8px; font-weight: bold; display: none; z-index: 3000;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
    </style>
</head>
<body>

    <nav>
        <div class="logo-wrap">
            <a href="index.html" class="logo">RIYAD<span>UINO</span></a>
        </div>
        <div class="nav-links">
            <a href="index.html" class="nav-text">HOME</a>
            
            <button class="icon-btn" onclick="window.openCart()">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-count" id="cartCount">0</span>
            </button>

            <button class="icon-btn" id="loginBtn" onclick="window.openLogin()">
                <i class="fas fa-user"></i> <span class="nav-text" style="font-size: 0.8rem; margin-left:5px;">LOGIN</span>
            </button>
            <img src="" id="userAvatar" class="user-avatar" onclick="window.userLogout()" title="Click to Logout">
        </div>
    </nav>

    <div class="container">
        <div class="store-header">
            <h1>OFFICIAL STORE</h1>
            <p style="color: var(--text-grey);">Authentic parts. Fast delivery within KSA.</p>
        </div>
        <div id="loader">LOADING PRODUCTS...</div>
        <div class="products-grid" id="productsGrid"></div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="window.closeModal('loginModal')">&times;</span>
            <h2 style="font-family: 'Orbitron'; color: var(--gold-primary); margin-bottom: 20px; text-align: center;">ACCESS STORE</h2>
            
            <input type="email" id="email" class="auth-input" placeholder="Email Address">
            <input type="password" id="password" class="auth-input" placeholder="Password">
            
            <button class="auth-btn btn-email" onclick="window.handleEmailAuth()">LOGIN / SIGN UP</button>
            <div style="text-align: center; margin: 15px 0; color: #555;">- OR -</div>
            <button class="auth-btn btn-google" onclick="window.handleGoogleAuth()">
                <i class="fab fa-google"></i> Continue with Google
            </button>
            <p id="authError" style="color: red; font-size: 0.8rem; margin-top: 10px; text-align: center;"></p>
        </div>
    </div>

    <div id="cartModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-modal" onclick="window.closeModal('cartModal')">&times;</span>
            <h2 style="font-family: 'Orbitron'; color: var(--gold-primary);">YOUR CART</h2>
            
            <div class="cart-items" id="cartItemsContainer">
                <p style="text-align: center; color: #666; padding: 20px;">Your cart is empty.</p>
            </div>
            
            <div class="cart-total">Total: <span id="cartTotal">0 SAR</span></div>
            <button class="checkout-btn" onclick="window.placeOrder()">PLACE ORDER (COD)</button>
        </div>
    </div>

    <div id="toast" class="toast">Item added to cart!</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, 
            signInWithEmailAndPassword, createUserWithEmailAndPassword, 
            signOut, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCSLy3xjL78iCWG9jLPTAIvi3-TJBPfsjw",
            authDomain: "riyaduino-sign-in-database.firebaseapp.com",
            projectId: "riyaduino-sign-in-database",
            storageBucket: "riyaduino-sign-in-database.firebasestorage.app",
            messagingSenderId: "783217624924",
            appId: "1:783217624924:web:183c079062776d3d06a399",
            measurementId: "G-GKFL5P02D5"
        };

        // INITIALIZE
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let cart = [];
        let currentUser = null;

        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('userAvatar').style.display = 'block';
                document.getElementById('userAvatar').src = user.photoURL || 'https://ui-avatars.com/api/?name=' + user.email;
                window.closeModal('loginModal');
            } else {
                document.getElementById('loginBtn').style.display = 'block';
                document.getElementById('userAvatar').style.display = 'none';
            }
        });

        // EXPORT FUNCTIONS TO WINDOW (So HTML onclick works)
        window.handleGoogleAuth = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(err => {
                document.getElementById('authError').innerText = err.message;
            });
        };

        window.handleEmailAuth = () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            if(!email || !pass) return;

            signInWithEmailAndPassword(auth, email, pass).catch(error => {
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    // Try SignUp if Login fails
                    createUserWithEmailAndPassword(auth, email, pass).catch(err => {
                        document.getElementById('authError').innerText = err.message;
                    });
                } else {
                    document.getElementById('authError').innerText = error.message;
                }
            });
        };

        window.userLogout = () => {
            if(confirm('Log out?')) signOut(auth);
        };

        // --- STORE & CART LOGIC ---
        const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTBQd3LUgZKxeuRQA2B0Cj3IvJBSSS0VL2vnmtOryQxFsAK-Kikg_NZTVGtlYghB96yFYyvqXrPGJEu/pub?output=csv";

        // Load Products
        Papa.parse(sheetURL, {
            download: true, header: true,
            complete: function(results) {
                renderProducts(results.data);
                document.getElementById('loader').style.display = 'none';
            }
        });

        function renderProducts(products) {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = "";
            products.forEach(p => {
                if(!p.name) return;
                const isStock = p.instock && p.instock.toUpperCase().trim() === 'TRUE';
                const price = p.price || "0";
                
                // Escape special characters for string arguments
                const safeName = p.name.replace(/'/g, "\\'");
                
                grid.innerHTML += `
                    <div class="product-card">
                        <div class="img-box">
                            <img src="${p.image || 'https://placehold.co/400?text=No+Image'}" alt="${p.name}">
                            <div class="status-badge ${isStock ? 'in-stock-badge' : 'out-stock-badge'}">
                                ${isStock ? 'IN STOCK' : 'SOLD OUT'}
                            </div>
                        </div>
                        <div class="p-info">
                            <div class="p-title">${p.name}</div>
                            <div class="p-desc">${p.description}</div>
                            <div class="p-price">${price}</div>
                            <button class="buy-btn ${isStock ? 'active' : 'disabled'}" 
                                onclick="${isStock ? `window.addToCart('${safeName}', '${price}')` : ''}">
                                ${isStock ? 'ADD TO CART' : 'OUT OF STOCK'}
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        window.addToCart = (name, price) => {
            cart.push({ name, price });
            updateCartUI();
            showToast();
        };

        window.removeFromCart = (index) => {
            cart.splice(index, 1);
            updateCartUI();
        };

        function updateCartUI() {
            document.getElementById('cartCount').innerText = cart.length;
            const container = document.getElementById('cartItemsContainer');
            
            if(cart.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Cart is empty.</p>';
                document.getElementById('cartTotal').innerText = "0 SAR";
                return;
            }

            let html = '';
            let total = 0;
            
            cart.forEach((item, index) => {
                let numPrice = parseFloat(item.price.replace(/[^0-9.]/g, '')) || 0;
                total += numPrice;
                
                html += `
                    <div class="cart-item">
                        <div>
                            <div style="color:white; font-weight:bold;">${item.name}</div>
                            <div style="font-size:0.8rem; color:var(--gold-primary);">${item.price}</div>
                        </div>
                        <button onclick="window.removeFromCart(${index})" style="color:red; background:none; border:none; cursor:pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('cartTotal').innerText = total + " SAR";
        }

        window.placeOrder = async () => {
            if (!currentUser) {
                window.closeModal('cartModal');
                window.openLogin();
                return;
            }
            if (cart.length === 0) return alert("Cart is empty!");

            const orderData = {
                user_email: currentUser.email,
                user_uid: currentUser.uid,
                items: cart,
                total: document.getElementById('cartTotal').innerText,
                status: "Pending",
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "orders"), orderData);
                alert("Order placed successfully! We will contact you via email.");
                cart = [];
                updateCartUI();
                window.closeModal('cartModal');
            } catch (error) {
                console.error("Error adding document: ", error);
                alert("Error placing order: " + error.message);
            }
        };

        function showToast() {
            const t = document.getElementById('toast');
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }

        // --- UI HELPERS (Exported) ---
        window.openLogin = () => document.getElementById('loginModal').style.display = 'flex';
        window.openCart = () => document.getElementById('cartModal').style.display = 'flex';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        // Close on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }
    </script>
</body>
</html>
